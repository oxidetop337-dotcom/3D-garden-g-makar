<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D –°–∞–¥ –¥. –ú–∞–∫–∞—Ä–∞ - Pro Edition</title>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; outline: none; }
        body { margin: 0; background: #1a1a1a; overflow: hidden; touch-action: none; font-family: sans-serif; }
        
        /* UI */
        #game-ui { display: none; position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        #stats { position: absolute; top: 15px; left: 15px; color: white; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 15px; pointer-events: auto; }
        
        /* –ú–∞–≥–∞–∑–∏–Ω */
        #shop-container {
            position: absolute; top: 10px; right: 10px;
            display: flex; flex-direction: column; align-items: flex-end;
            pointer-events: auto; width: 180px;
        }
        #game-shop { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .shop-item {
            background: white; border: 2px solid #ddd; padding: 6px; border-radius: 8px;
            font-size: 12px; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center;
        }
        .shop-item.active { border-color: #e67e22; background: #fff3e0; }
        .stock { font-size: 10px; color: #e67e22; }
        #shop-timer { color: white; background: rgba(0,0,0,0.5); padding: 4px; border-radius: 5px; font-size: 11px; margin-top: 5px; width: 100%; text-align: center; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; }
        .dpad { display: grid; grid-template-columns: repeat(3, 65px); gap: 8px; pointer-events: auto; }
        .btn { width: 65px; height: 65px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 15px; color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; }
        .btn-act { width: 90px; height: 90px; background: #ff9800; border-radius: 50%; border: 4px solid white; color: white; pointer-events: auto; font-weight: bold; }
        
        #main-menu { position: absolute; width: 100%; height: 100%; background: #27ae60; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .menu-btn { padding: 15px 40px; font-size: 20px; border-radius: 10px; border: none; background: white; color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>

<div id="main-menu">
    <h1>GARDEN BY MAKART</h1>
    <button class="menu-btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
    <p>–°–æ–∑–¥–∞—Ç–µ–ª—å: –¥. –ú–∞–∫–∞—Ä</p>
</div>

<div id="game-ui">
    <div id="stats">üí∞ <span id="money">100</span></div>
    
    <div id="shop-container">
        <div id="game-shop"></div>
        <div id="shop-timer">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 05:00</div>
    </div>

    <div id="controls">
        <div class="dpad">
            <div></div><div class="btn" id="b-u">‚ñ≤</div><div></div>
            <div class="btn" id="b-l">‚óÄ</div><div class="btn" id="b-d">‚ñº</div><div class="btn" id="b-r">‚ñ∂</div>
        </div>
        <button class="btn-act" id="b-a">–û–ö</button>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let isGameRunning = false, money = 100, selected = null;
    const plants = [];

    // –ë–ê–ó–ê 30 –í–ò–î–û–í (–®–∞–Ω—Å: —á–µ–º –≤—ã—à–µ —Ü–µ–Ω–∞, —Ç–µ–º –º–µ–Ω—å—à–µ —à–∞–Ω—Å)
    const ALL_ITEMS = [
        { n: 'üçé', c: 5, cl: 0xff4d4d, r: 12, p: 90 }, { n: 'üçê', c: 8, cl: 0xdde26a, r: 18, p: 85 },
        { n: 'ü•ï', c: 10, cl: 0xffa502, r: 25, p: 80 }, { n: 'üçÖ', c: 12, cl: 0xff6b81, r: 30, p: 75 },
        { n: 'üçÜ', c: 15, cl: 0xa55eea, r: 40, p: 70 }, { n: 'ü•î', c: 20, cl: 0xd1ccc0, r: 50, p: 65 },
        { n: 'üåΩ', c: 25, cl: 0xffed33, r: 65, p: 60 }, { n: 'üçá', c: 30, cl: 0x706fd3, r: 80, p: 55 },
        { n: 'üçà', c: 40, cl: 0x7bed9f, r: 110, p: 50 }, { n: 'üçâ', c: 50, cl: 0x26de81, r: 140, p: 45 },
        { n: 'üçä', c: 60, cl: 0xffa502, r: 170, p: 40 }, { n: 'üçå', c: 70, cl: 0xfff200, r: 200, p: 35 },
        { n: 'üçç', c: 85, cl: 0xeccc68, r: 250, p: 30 }, { n: 'üçì', c: 100, cl: 0xff4757, r: 300, p: 25 },
        { n: 'üçí', c: 120, cl: 0xeb4d4b, r: 370, p: 22 }, { n: 'ü´ê', c: 150, cl: 0x4834d4, r: 450, p: 20 },
        { n: 'ü•ù', c: 180, cl: 0x6ab04c, r: 550, p: 18 }, { n: 'ü•ë', c: 220, cl: 0xbadc58, r: 700, p: 16 },
        { n: 'üçÑ', c: 260, cl: 0xff7979, r: 850, p: 14 }, { n: 'üå∞', c: 300, cl: 0x795548, r: 1000, p: 12 },
        { n: 'ü••', c: 400, cl: 0xf1f2f6, r: 1400, p: 10 }, { n: 'üå∂Ô∏è', c: 500, cl: 0xff0000, r: 1800, p: 8 },
        { n: 'üçã', c: 650, cl: 0xffff00, r: 2400, p: 6 }, { n: 'üç≠', c: 800, cl: 0xff9ff3, r: 3000, p: 4 },
        { n: 'üçÄ', c: 1000, cl: 0x00ff00, r: 4000, p: 3 }, { n: 'üîî', c: 1500, cl: 0xffd32a, r: 6000, p: 2 },
        { n: 'üíé', c: 2500, cl: 0x0fbcf9, r: 10000, p: 1.5 }, { n: 'üëë', c: 5000, cl: 0xffdd59, r: 25000, p: 1 },
        { n: 'üå†', c: 10000, cl: 0x575fcf, r: 60000, p: 0.5 }, { n: 'ü•ö', c: 25000, cl: 0xffffff, r: 200000, p: 0.1 }
    ];

    function refreshShop() {
        const shopEl = document.getElementById('game-shop');
        shopEl.innerHTML = '';
        
        // –†–æ—Ç–∞—Ü–∏—è: —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —à–∞–Ω—Å—É –ø–æ—è–≤–ª–µ–Ω–∏—è
        let available = [];
        while(available.length < 4) {
            let item = ALL_ITEMS[Math.floor(Math.random() * ALL_ITEMS.length)];
            if(Math.random() * 100 <= item.p) {
                if(!available.includes(item)) {
                    item.stock = Math.floor(Math.random() * 5) + 2; // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–µ–º—è–Ω
                    available.push(item);
                }
            }
        }

        available.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'shop-item' + (i === 0 ? ' active' : '');
            div.innerHTML = `<span>${item.n} $${item.c}</span> <span class="stock" id="st-${i}">x${item.stock}</span>`;
            div.onclick = () => {
                document.querySelectorAll('.shop-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                selected = item;
                selected.uiIdx = i;
            };
            shopEl.appendChild(div);
            if(i === 0) { selected = item; selected.uiIdx = 0; }
        });
    }

    // --- THREE.JS ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x7bed9f);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6), new THREE.DirectionalLight(0xffffff, 1));
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x2ed573 }));
    ground.rotation.x = -Math.PI/2; scene.add(ground);

    const player = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 0.5, 4, 8), new THREE.MeshStandardMaterial({ color: 0x1e90ff }));
    player.position.y = 0.4; scene.add(player);
    camera.position.set(0, 10, 10);

    const move = { u:0, d:0, l:0, r:0 };
    const setup = (id, k) => {
        const el = document.getElementById(id);
        el.ontouchstart = (e) => { e.preventDefault(); move[k] = 1; };
        el.ontouchend = () => move[k] = 0;
    };
    setup('b-u','u'); setup('b-d','d'); setup('b-l','l'); setup('b-r','r');

    // –ö–Ω–æ–ø–∫–∞ –û–ö
    document.getElementById('b-a').onclick = () => {
        let col = false;
        plants.forEach((group, i) => {
            if (group[0].position.distanceTo(player.position) < 1.5 && group[0].userData.ready) {
                group.forEach(p => scene.remove(p));
                plants.splice(i, 1);
                money += (group[0].userData.reward * group.length);
                col = true;
            }
        });

        if (!col && selected && selected.stock > 0 && money >= selected.c) {
            money -= selected.c;
            selected.stock--;
            document.getElementById(`st-${selected.uiIdx}`).innerText = 'x' + selected.stock;

            const group = [];
            const count = Math.floor(Math.random() * 5) + 3; // –û—Ç 3 –¥–æ 7 –ø–ª–æ–¥–æ–≤ —Å—Ä–∞–∑—É
            for(let i=0; i<count; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshStandardMaterial({ color: 0x747d8c }));
                p.position.set(player.position.x + (Math.random()-0.5), 0.1, player.position.z + (Math.random()-0.5));
                p.userData = { ready: false, reward: selected.r };
                scene.add(p);
                group.push(p);

                let s = 1;
                const g = setInterval(() => {
                    s += 0.2; p.scale.set(s,s,s); p.position.y = (s*0.1);
                    if(s >= 4) { p.material.color.set(selected.cl); p.userData.ready = true; clearInterval(g); }
                }, 150);
            }
            plants.push(group);
        }
        document.getElementById('money').innerText = Math.floor(money);
    };

    window.startGame = () => {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        isGameRunning = true;
        refreshShop();
    };

    function updateTimer() {
        const now = Date.now();
        const cycle = 5 * 60 * 1000;
        const left = (Math.ceil(now / cycle) * cycle) - now;
        const m = Math.floor(left / 60000), s = Math.floor((left % 60000) / 1000);
        document.getElementById('shop-timer').innerText = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${m}:${s < 10 ? '0' + s : s}`;
        if (left <= 1000) setTimeout(refreshShop, 1100);
    }

    function animate() {
        requestAnimationFrame(animate);
        if(!isGameRunning) { renderer.render(scene, camera); return; }
        const s = 0.12;
        if(move.u) player.position.z -= s; if(move.d) player.position.z += s;
        if(move.l) player.position.x -= s; if(move.r) player.position.x += s;
        camera.position.lerp(new THREE.Vector3(player.position.x, 10, player.position.z + 10), 0.1);
        camera.lookAt(player.position);
        renderer.render(scene, camera);
        updateTimer();
    }
    animate();
</script>
</body>
</html>
